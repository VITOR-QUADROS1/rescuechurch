<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mural — Igreja do Resgate</title>
  <meta name="theme-color" content="#10141E">
  <link rel="icon" href="logo.png">
  <link rel="stylesheet" href="style.css">

  <style>
    /* =========================
       MODAL (fixo, não invade página)
    ========================= */
    .img-modal[hidden] { display: none !important; }

    .img-modal{
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(6px);
    }

    .img-box{
      position: relative;
      width: auto;
      max-width: 96vw;
      max-height: 92vh;
      padding: 0;
      background: transparent;
      border: none;
      box-shadow: none;
      overflow: visible;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .img-box figure{
      margin:0;
      width: 100%;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    .img-box img{
      display:block;
      width:auto;
      height:auto;
      max-width:96vw;
      max-height:90vh;
      object-fit:contain;
      border-radius:12px;
      background:#000;
    }

    .img-box video{
      display:block;
      width:auto;
      height:auto;
      max-width:96vw;
      max-height:90vh;
      border-radius:12px;
      background:#000;
    }

    .img-caption{
      margin-top:10px;
      padding:6px 10px;
      background:rgba(0,0,0,.55);
      border-radius:10px;
      text-align:center;
      color:#fff;
      max-width: 92vw;
    }

    .img-close{
      position: absolute;
      right: 10px;
      top: 10px;
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 0;
      cursor: pointer;
      font-size: 18px;
      line-height: 40px;
      color: #fff;
      background: rgba(0,0,0,.55);
      z-index: 10000;
    }

    /* =========================
       THUMB "TIPO YOUTUBE"
    ========================= */
    .gallery-item{
      position:relative;
      display:block;
    }

    .video-thumb{
      width:100%;
      height:100%;
      display:block;
      object-fit:cover;
      border-radius: 0; /* seu CSS externo pode aplicar */
      background:#000;
    }

    .play-overlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }

    .play-badge{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border-radius:999px;
      background: rgba(0,0,0,.55);
      color:#fff;
      font-size:14px;
      font-weight:600;
    }

    .play-tri{
      width:0;
      height:0;
      border-left:12px solid #fff;
      border-top:8px solid transparent;
      border-bottom:8px solid transparent;
    }

    /* Placeholder enquanto gera thumb */
    .thumb-loading{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#000;
      color:#fff;
      font-size:14px;
      opacity:.85;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <a href="https://www.youtube.com/channel/UC11Km85MPiYbuPmG7Lz2Wjg" target="_blank" rel="noopener" class="brand-link">
      <div class="brand">
        <img src="logo.png" class="brand-logo" alt="Rescue Church">
        <span>Igreja do Resgate</span>
      </div>
    </a>
    <nav class="menu">
      <a href="../index.html#inicio">Início</a>
      <a href="../index.html#vdia">Versículo do Dia</a>
      <a href="../index.html#buscar">Buscar na Bíblia</a>
      <a href="../index.html#videos">Vídeos & Lives</a>
      <a href="mural.html" aria-current="page">Mural</a>
    </nav>
  </header>

  <main class="container">
    <section class="card section">
      <div class="section-head" style="text-align:center;">
        <h2>Mural da Comunidade</h2>
      </div>

      <div id="gallery" class="gallery-grid"></div>

      <p class="muted" style="margin-top:14px">
        Dica: clique numa foto/vídeo para ampliar · use as setas do teclado (← →) · ESC para fechar
      </p>

      <div style="margin-top:18px; text-align:right">
        <a href="../index.html" class="btn pill">Voltar ao início</a>
      </div>
    </section>
  </main>

  <div id="imgModal" class="img-modal" hidden>
    <div class="img-box">
      <button class="img-close" aria-label="Fechar" type="button">✕</button>

      <figure>
        <img id="imgFull" src="" alt="" hidden />
        <video id="vidFull" controls playsinline preload="metadata" hidden></video>
        <figcaption id="imgCaption" class="img-caption"></figcaption>
      </figure>
    </div>
  </div>

  <script>
    // ==========================================
    // CONFIG: segundo do vídeo usado como thumb
    // ==========================================
    const THUMB_SECOND = 10;

    // ==========================================
    // LISTA DO MURAL (vários vídeos sem poster)
    // Só coloque src e pronto.
    // ==========================================
    const GALLERY = [
      { src: "mural/quartas.jpg", title: "" },
      { src: "mural/video.mp4", title: "Culto — vídeo" },
      // Adicione mais vídeos:
      // { src: "mural/video2.mp4", title: "Ensaio — vídeo" },
      { src: "mural/sexta.jpeg", title: "" },
      { src: "mural/domingo.jpg", title: "" },
    ];

    function getExt(path) {
      const clean = String(path).split('?')[0].split('#')[0];
      const parts = clean.split('.');
      return (parts.length > 1 ? parts.pop() : '').toLowerCase();
    }
    function isVideoSrc(src) {
      const ext = getExt(src);
      return ['mp4', 'webm', 'ogg'].includes(ext);
    }

    // ==========================================
    // Render grid
    // Para vídeo, cria um <img> placeholder e gera thumb via canvas
    // ==========================================
    const $grid = document.getElementById('gallery');

    $grid.innerHTML = GALLERY.map((item, i) => {
      const video = isVideoSrc(item.src);

      if (video) {
        return `
          <a href="${item.src}" class="gallery-item" data-index="${i}" data-type="video" data-src="${item.src}">
            <div class="thumb-loading" data-loading="1">Carregando vídeo…</div>
            <img class="video-thumb" alt="${item.title || 'Vídeo'}" hidden>
            <div class="play-overlay">
              <div class="play-badge"><span class="play-tri"></span>Vídeo</div>
            </div>
            <div class="gallery-caption"></div>
          </a>
        `;
      }

      return `
        <a href="${item.src}" class="gallery-item" data-index="${i}" data-type="image" data-src="${item.src}">
          <img src="${item.src}" alt="${item.title || ''}">
          <div class="gallery-caption"></div>
        </a>
      `;
    }).join('');

    // ==========================================
    // Gerar thumbnail automático do vídeo no segundo THUMB_SECOND
    // ==========================================
    async function makeVideoThumb(videoUrl, atSecond) {
      return new Promise((resolve, reject) => {
        const v = document.createElement('video');
        v.muted = true;
        v.playsInline = true;
        v.preload = 'metadata';
        v.crossOrigin = 'anonymous'; // ok se for mesmo domínio; se não, pode falhar
        v.src = videoUrl;

        const cleanup = () => {
          v.removeAttribute('src');
          v.load();
        };

        v.addEventListener('error', () => {
          cleanup();
          reject(new Error('erro ao carregar vídeo'));
        }, { once: true });

        v.addEventListener('loadedmetadata', () => {
          const dur = Number(v.duration);
          let t = atSecond;

          // se vídeo for menor que 10s, pega 1s ou metade
          if (isFinite(dur) && dur > 0) {
            if (t >= dur) t = Math.max(0.5, dur * 0.25);
          } else {
            t = 1;
          }

          const onSeeked = () => {
            try {
              const canvas = document.createElement('canvas');
              canvas.width = v.videoWidth || 640;
              canvas.height = v.videoHeight || 360;

              const ctx = canvas.getContext('2d');
              ctx.drawImage(v, 0, 0, canvas.width, canvas.height);

              const dataUrl = canvas.toDataURL('image/jpeg', 0.82);
              cleanup();
              resolve(dataUrl);
            } catch (e) {
              cleanup();
              reject(e);
            }
          };

          v.addEventListener('seeked', onSeeked, { once: true });

          // força seek pro tempo desejado
          try {
            v.currentTime = t;
          } catch (e) {
            cleanup();
            reject(e);
          }
        }, { once: true });
      });
    }

    async function generateAllVideoThumbs() {
      const videoCards = Array.from(document.querySelectorAll('.gallery-item[data-type="video"]'));
      for (const card of videoCards) {
        const src = card.getAttribute('data-src');
        const img = card.querySelector('img.video-thumb');
        const loading = card.querySelector('[data-loading="1"]');

        try {
          const thumb = await makeVideoThumb(src, THUMB_SECOND);
          img.src = thumb;
          img.hidden = false;
          if (loading) loading.remove();
        } catch (e) {
          // fallback: remove "carregando", deixa um fundo preto
          if (loading) loading.textContent = 'Vídeo';
          img.hidden = true;
        }
      }
    }

    // chama após montar grid
    generateAllVideoThumbs();

    // ==========================================
    // Modal: abre/fecha e navegação
    // ==========================================
    const $modal    = document.getElementById('imgModal');
    const $imgFull  = document.getElementById('imgFull');
    const $vidFull  = document.getElementById('vidFull');
    const $caption  = document.getElementById('imgCaption');
    const $closeBtn = $modal.querySelector('.img-close');

    let current = -1;

    function stopVideo() {
      try {
        $vidFull.pause();
        $vidFull.removeAttribute('src');
        $vidFull.load();
      } catch(e) {}
    }

    function showImage(src, title) {
      stopVideo();
      $vidFull.hidden = true;

      $imgFull.hidden = false;
      $imgFull.src = src;
      $imgFull.alt = title || '';
    }

    function showVideo(src, title) {
      $imgFull.hidden = true;
      $imgFull.src = '';
      $imgFull.alt = '';

      $vidFull.hidden = false;
      $vidFull.src = src;
      $vidFull.load();

      const p = $vidFull.play();
      if (p && typeof p.catch === 'function') p.catch(() => {});
    }

    function openModal(index) {
      current = index;
      const it = GALLERY[current];
      const title = it.title || '';

      $caption.textContent = title;
      $modal.hidden = false;

      if (isVideoSrc(it.src)) showVideo(it.src, title);
      else showImage(it.src, title);
    }

    function closeModal() {
      $modal.hidden = true;
      $caption.textContent = '';
      $imgFull.src = '';
      $imgFull.alt = '';
      $imgFull.hidden = true;
      stopVideo();
      $vidFull.hidden = true;
      current = -1;
    }

    function nextItem() {
      if (!GALLERY.length) return;
      current = (current + 1) % GALLERY.length;
      openModal(current);
    }

    function prevItem() {
      if (!GALLERY.length) return;
      current = (current - 1 + GALLERY.length) % GALLERY.length;
      openModal(current);
    }

    $grid.addEventListener('click', (ev) => {
      const a = ev.target.closest('a.gallery-item');
      if (!a) return;
      ev.preventDefault();
      const i = parseInt(a.getAttribute('data-index'), 10);
      if (!Number.isNaN(i)) openModal(i);
    });

    $closeBtn.addEventListener('click', (ev) => {
      ev.preventDefault();
      ev.stopPropagation();
      closeModal();
    });

    $modal.addEventListener('click', (ev) => {
      if (ev.target === $modal) closeModal();
    });

    window.addEventListener('keydown', (ev) => {
      if ($modal.hidden) return;
      if (ev.key === 'Escape') closeModal();
      else if (ev.key === 'ArrowRight') nextItem();
      else if (ev.key === 'ArrowLeft')  prevItem();
    });
  </script>
</body>
</html>
